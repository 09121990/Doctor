SELECT 
    A."Doctor", 
    A."Count of Patients Advised DHI", 
    COALESCE(B."Count of Patients Taken DHI", 0) AS "Count of Patients Taken DHI", 
    COALESCE(B."Count of Patients Taken DHI" / NULLIF(A."Count of Patients Advised DHI", 0), 0) AS "% Converted"
FROM
(
    -- Count of patients advised DHI
    SELECT
        "SNAME" AS "Doctor",
        COUNT(DISTINCT "LTHMS"."ADVICETYPE"."PATID") AS "Count of Patients Advised DHI"
    FROM "LTHMS"."ADVICETYPE"
    LEFT JOIN "LTHMS"."RECEIPTDETAIL" 
        ON "RECEIPTDETAIL"."BILLNO" = "ADVICETYPE"."BILLNO"
    LEFT JOIN "LTHMS"."CLINICPERSONNEL" 
        ON "CLINICPERSONNEL"."SID" = "RECEIPTDETAIL"."SID"
    WHERE 
        LOWER("LTHMS"."ADVICETYPE"."OPERATION") NOT LIKE '%dhi%'
        AND "ADVICETYPE"."ADVDATE" BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                                      AND TO_DATE('2025-01-31', 'YYYY-MM-DD') 
    GROUP BY "SNAME"
) A
LEFT JOIN
(
    -- Count of patients taken DHI
    SELECT
        "SNAME" AS "Doctor",
        COUNT(DISTINCT "OPTCHARGEDETAIL"."PATID") AS "Count of Patients Taken DHI"
    FROM "LTHMS"."OPTCHARGEDETAIL"
    LEFT JOIN "LTHMS"."CLINICPERSONNEL" 
        ON "CLINICPERSONNEL"."SID" = "OPTCHARGEDETAIL"."SID"
    WHERE 
        (LOWER("OPTCHARGEDETAIL"."RPATTYPE") NOT LIKE '%dhi%' OR "OPTCHARGEDETAIL"."RPATTYPE" IS NULL) -- FIXED FILTER
        AND "OPTCHARGEDETAIL"."PATID" IN (
            SELECT DISTINCT "PATID" 
            FROM "LTHMS"."ADVICETYPE" 
            WHERE LOWER("LTHMS"."ADVICETYPE"."OPERATION") NOT LIKE '%dhi%'
                AND "ADVICETYPE"."ADVDATE" BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                                              AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
        ) 
        AND "OPTCHARGEDETAIL"."BILLDATE" BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                                             AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
    GROUP BY "SNAME"
) B 
ON B."Doctor" = A."Doctor"
ORDER BY A."Doctor";
