-----------------------------------Version 01
SELECT
   --CP.SID AS "Dr_ID",
  CP.SNAME AS "Dr_Name",
   NVL(PNT."NEW_PATIENT",0) AS  "New Patient", -- Include Patient Count from the subquery
   (COUNT(DISTINCT RD2.PATID) - NVL(PNT."NEW_PATIENT",0)) AS "Old Patient",
   COUNT(DISTINCT RD2.PATID) AS "Total Patient",    -- Total consultation Patien
   COUNT(DISTINCT RD.PATID) AS "Consultation to Procedure ",
    CASE 
        WHEN COUNT(DISTINCT RD2.PATID) > 0 THEN 
            TO_CHAR((COUNT(DISTINCT RD.PATID) / COUNT(DISTINCT RD2.PATID)) * 100, 'FM99999990.0') || '%'
        ELSE '0%' 
    END AS "Conversion",  -- Conversion as percentage with 2 decimal places
   COUNT(DISTINCT OCD.PATID) AS "Total Procedure",
   COALESCE(OCD_TOTAL.Discount, 0) AS Discount,
   COALESCE(OCD_TOTAL.Receive_Amount, 0) AS "Procedure Receive Revenue",
   COALESCE(OCD_TOTAL.Honor_Amount, 0) AS "Honor Amount",
   COALESCE(OCD_TOTAL.OCD_TOTAL.Collection_Amount, 0) AS Collection_Amount

FROM LTHMS.CLINICPERSONNEL CP
LEFT JOIN (
    SELECT 
        RD.SID AS "Doctor ID",  
        COUNT(DISTINCT PNTS.PATID) AS "NEW_PATIENT"  -- Counting distinct patients assigned to each doctor
    FROM LTHMS.RECEIPTDETAIL RD
    JOIN LTHMS.PATIENTS PNTS 
        ON RD.PATID = PNTS.PATID  -- Joining with patients table to apply registration date filter
    WHERE PNTS.REGISDATE BETWEEN DATE '2024-09-01' AND DATE '2024-09-30'  
    AND RD.AMOUNT > 0
    AND RD.RCPTDATE BETWEEN DATE '2024-09-01' AND DATE '2024-09-30'  
   /* AND RD.SID = (
        -- Subquery: Selecting the first doctor each patient visited
        SELECT MIN(RD2.SID) KEEP (DENSE_RANK FIRST ORDER BY RD2.RCPTDATE)  
        FROM LTHMS.RECEIPTDETAIL RD2  
        WHERE RD2.PATID = RD.PATID  -- Matching the same patient
        AND RD2.RCPTDATE BETWEEN DATE '2024-09-01' AND DATE '2024-09-30'  -- Considering visits only within the date range
    ) */
    GROUP BY RD.SID  -- Group by doctor ID
) PNT 
  ON PNT."Doctor ID" = CP.SID  -- Join the subquery to the main query on SID
LEFT JOIN (
    SELECT SID, PATID, NETAMT
    FROM LTHMS.OPTCHARGEDETAIL
    WHERE BILLDATE BETWEEN TO_DATE('2024-09-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2024-09-30', 'YYYY-MM-DD')
    AND LOWER(RPATTYPE) NOT LIKE '%dhi%'
) OCD 
  ON OCD.SID = CP.SID
LEFT JOIN (
    SELECT SID, PATID
    FROM LTHMS.RECEIPTDETAIL
    WHERE AMOUNT > 0 AND
    RCPTDATE BETWEEN TO_DATE('2024-09-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2024-09-30', 'YYYY-MM-DD')
    GROUP BY SID, PATID
) RD 
  ON OCD.SID = RD.SID  
  AND  OCD.PATID = RD.PATID
LEFT JOIN (
    SELECT SID, PATID
    FROM LTHMS.RECEIPTDETAIL
    WHERE AMOUNT > 0 AND
    RCPTDATE BETWEEN TO_DATE('2024-09-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2024-09-30', 'YYYY-MM-DD')
    GROUP BY SID, PATID
) RD2 
  ON CP.SID = RD2.SID  -- Join directly on CP.SID
LEFT JOIN (
    SELECT SID,SUM(LTHMS.OPTCHARGEDETAIL.DISCOUNT) AS Discount, SUM(RECAMOUNT) AS Receive_Amount,SUM(HONORAMT) AS Honor_Amount,SUM(NETCOLLECTION) AS Collection_Amount
    FROM LTHMS.OPTCHARGEDETAIL
    WHERE BILLDATE BETWEEN TO_DATE('2024-09-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2024-09-30', 'YYYY-MM-DD')
    AND LOWER(RPATTYPE) NOT LIKE '%dhi%'
    GROUP BY SID
) OCD_TOTAL 
  ON CP.SID = OCD_TOTAL.SID
WHERE OCD_TOTAL.Receive_Amount > 0
GROUP BY CP.SID,CP.SNAME,OCD_TOTAL.Discount, OCD_TOTAL.Receive_Amount, OCD_TOTAL.Honor_Amount,OCD_TOTAL.Collection_Amount,PNT."NEW_PATIENT"  -- Include Patient Count in GROUP BY
ORDER BY "Procedure Receive Revenue" DESC;

-------------------------------------------- Only new Patient Pivot Table

SELECT 
    CP.SID AS "Doctor ID",
    CP.SNAME AS "Dr.Name",
    NVL(COUNT(DISTINCT CASE WHEN TO_CHAR(PNTS.REGISDATE, 'YYYY-MM') = '2024-09' THEN PNTS.PATID END), 0) AS "Sep-2024",
    NVL(COUNT(DISTINCT CASE WHEN TO_CHAR(PNTS.REGISDATE, 'YYYY-MM') = '2024-10' THEN PNTS.PATID END), 0) AS "Oct-2024",
    NVL(COUNT(DISTINCT CASE WHEN TO_CHAR(PNTS.REGISDATE, 'YYYY-MM') = '2024-11' THEN PNTS.PATID END), 0) AS "Nov-2024",
    NVL(COUNT(DISTINCT CASE WHEN TO_CHAR(PNTS.REGISDATE, 'YYYY-MM') = '2024-12' THEN PNTS.PATID END), 0) AS "Dec-2024",
    NVL(COUNT(DISTINCT CASE WHEN TO_CHAR(PNTS.REGISDATE, 'YYYY-MM') = '2025-01' THEN PNTS.PATID END), 0) AS "Jan-2025",
    NVL(COUNT(DISTINCT CASE WHEN TO_CHAR(PNTS.REGISDATE, 'YYYY-MM') = '2025-02' THEN PNTS.PATID END), 0) AS "Feb-2025",
    COUNT(DISTINCT PNTS.PATID) AS "Total New Patients"
FROM LTHMS.CLINICPERSONNEL CP
LEFT JOIN LTHMS.RECEIPTDETAIL RD ON CP.SID = RD.SID
LEFT JOIN LTHMS.PATIENTS PNTS ON RD.PATID = PNTS.PATID  
WHERE PNTS.REGISDATE BETWEEN DATE '2024-09-01' AND DATE '2025-02-28'  
AND RD.AMOUNT > 0
AND RD.RCPTDATE BETWEEN DATE '2024-09-01' AND DATE '2025-02-28'  
GROUP BY CP.SID,CP.SNAME
ORDER BY "Total New Patients" Desc;


-------------------------------------------- with Date Parameter

WITH DATE_PARAMS AS (
    SELECT 
        TO_DATE('2025-02-01', 'YYYY-MM-DD') AS start_date, 
        TO_DATE('2025-02-28', 'YYYY-MM-DD') AS end_date
    FROM DUAL
)
SELECT
    CP.SNAME AS "Dr_Name",
    COUNT(DISTINCT OCD.PATID) AS "Procedure All Patient",
    COUNT(DISTINCT RD.PATID) AS "Take Procedure from Receive",
    COALESCE(OCD_TOTAL.NETAMT_SUM, 0) AS "Procedure Amount",
    COUNT(DISTINCT RD2.PATID) AS "All Patient from Receive",
    NVL(PNT."NEW_PATIENT", 0) AS "NEW PATIENT"
FROM LTHMS.CLINICPERSONNEL CP
LEFT JOIN (
    SELECT 
        RD.SID AS "Doctor ID",  
        COUNT(DISTINCT RD.PATID) AS "NEW_PATIENT"
    FROM LTHMS.RECEIPTDETAIL RD
    JOIN LTHMS.PATIENTS PNTS 
        ON RD.PATID = PNTS.PATID
    JOIN DATE_PARAMS 
        ON PNTS.REGISDATE BETWEEN DATE_PARAMS.start_date AND DATE_PARAMS.end_date
       AND RD.RCPTDATE BETWEEN DATE_PARAMS.start_date AND DATE_PARAMS.end_date
    WHERE RD.SID = (
        SELECT MIN(RD2.SID) KEEP (DENSE_RANK FIRST ORDER BY RD2.RCPTDATE)
        FROM LTHMS.RECEIPTDETAIL RD2  
        WHERE RD2.PATID = RD.PATID
        AND RD2.RCPTDATE BETWEEN DATE_PARAMS.start_date AND DATE_PARAMS.end_date
    )
    GROUP BY RD.SID
) PNT 
  ON PNT."Doctor ID" = CP.SID
LEFT JOIN (
    SELECT SID, PATID, NETAMT
    FROM LTHMS.OPTCHARGEDETAIL, DATE_PARAMS
    WHERE BILLDATE BETWEEN DATE_PARAMS.start_date AND DATE_PARAMS.end_date
    AND LOWER(RPATTYPE) NOT LIKE '%dhi%'
) OCD 
  ON OCD.SID = CP.SID
LEFT JOIN (
    SELECT SID, PATID
    FROM LTHMS.RECEIPTDETAIL, DATE_PARAMS
    WHERE RCPTDATE BETWEEN DATE_PARAMS.start_date AND DATE_PARAMS.end_date
    GROUP BY SID, PATID
) RD 
  ON OCD.SID = RD.SID 
  AND OCD.PATID = RD.PATID
LEFT JOIN (
    SELECT SID, PATID
    FROM LTHMS.RECEIPTDETAIL, DATE_PARAMS
    WHERE RCPTDATE BETWEEN DATE_PARAMS.start_date AND DATE_PARAMS.end_date
    GROUP BY SID, PATID
) RD2 
  ON CP.SID = RD2.SID
LEFT JOIN (
    SELECT SID, SUM(NETAMT) AS NETAMT_SUM
    FROM LTHMS.OPTCHARGEDETAIL, DATE_PARAMS
    WHERE BILLDATE BETWEEN DATE_PARAMS.start_date AND DATE_PARAMS.end_date
    AND LOWER(RPATTYPE) NOT LIKE '%dhi%'
    GROUP BY SID
) OCD_TOTAL 
  ON CP.SID = OCD_TOTAL.SID
WHERE OCD_TOTAL.NETAMT_SUM <> 0
GROUP BY CP.SNAME, OCD_TOTAL.NETAMT_SUM, PNT."NEW_PATIENT"
ORDER BY "Procedure Amount" DESC;
