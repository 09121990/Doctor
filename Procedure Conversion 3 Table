SELECT
  CP.SNAME AS "Dr_Name",
  COUNT(DISTINCT OCD.PATID) AS "Procedure All Patient",
  COUNT(DISTINCT RD.PATID) AS "Take Procedure from Receive",
  COALESCE(OCD_TOTAL.NETAMT_SUM, 0) AS "Procedure Amount",
  COUNT(DISTINCT RD2.PATID) AS "All Patient from Receive"
FROM LTHMS.CLINICPERSONNEL CP
LEFT JOIN (
    SELECT SID, PATID, NETAMT
    FROM LTHMS.OPTCHARGEDETAIL
    WHERE BILLDATE BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
    AND LOWER(RPATTYPE) NOT LIKE '%dhi%'
) OCD 
  ON OCD.SID = CP.SID
LEFT JOIN (
    SELECT SID, PATID
    FROM LTHMS.RECEIPTDETAIL
    WHERE RCPTDATE BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
    GROUP BY SID, PATID  -- Group by to remove duplicates
) RD 
  ON OCD.SID = RD.SID 
  AND OCD.PATID = RD.PATID
LEFT JOIN (
    SELECT SID, PATID
    FROM LTHMS.RECEIPTDETAIL
    WHERE RCPTDATE BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
    GROUP BY SID, PATID  -- Group by to remove duplicates
) RD2 
  ON CP.SID = RD2.SID  -- Join directly on CP.SID
LEFT JOIN (
    SELECT SID, SUM(NETAMT) AS NETAMT_SUM
    FROM LTHMS.OPTCHARGEDETAIL
    WHERE BILLDATE BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
    AND LOWER(RPATTYPE) NOT LIKE '%dhi%'
    GROUP BY SID
) OCD_TOTAL 
  ON CP.SID = OCD_TOTAL.SID
  WHERE NETAMT_SUM <> 0
GROUP BY CP.SNAME, OCD_TOTAL.NETAMT_SUM
ORDER BY "Procedure Amount" DESC;
