SELECT
  CLINICPERSONNEL.SNAME AS "Dr_Name",
  COUNT(DISTINCT OPTCHARGEDETAIL.PATID) AS "Total New Patient",
  TO_CHAR(SUM(OPTCHARGEDETAIL.NETAMT), 'FM999,99,999') AS "Procedure Amount",
  TO_CHAR(SUM(OPTCHARGEDETAIL.NETAMT) / COUNT(DISTINCT OPTCHARGEDETAIL.PATID), 'FM999,99,999') AS "Avg Income Per Patient"
FROM
  LTHMS.OPTCHARGEDETAIL
  LEFT JOIN LTHMS.CLINICPERSONNEL ON OPTCHARGEDETAIL.SID = CLINICPERSONNEL.SID
WHERE BILLDATE BETWEEN TO_DATE('2024-08-01', 'YYYY-MM-DD') 
                        AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
  AND LOWER(OPTCHARGEDETAIL.RPATTYPE) NOT LIKE '%dhi%'
GROUP BY
  CLINICPERSONNEL.SNAME
ORDER BY
  SUM(OPTCHARGEDETAIL.NETAMT) DESC;
