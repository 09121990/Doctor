WITH DeduplicatedDoctors AS (
    SELECT DISTINCT RD.PATID, CP.SNAME
    FROM LTHMS.RECEIPTDETAIL RD
    JOIN LTHMS.CLINICPERSONNEL CP ON RD.SID = CP.SID
    WHERE RD.RCPTDATE BETWEEN DATE '2025-01-01' AND DATE '2025-01-31'
)
SELECT 
    PNTS.PATID AS "Patient ID",
    COUNT(DISTINCT RD.SID) AS "Dr_ID",
    NVL(
        (SELECT LISTAGG(DD.SNAME, ', ') WITHIN GROUP (ORDER BY DD.SNAME)
         FROM DeduplicatedDoctors DD
         WHERE DD.PATID = PNTS.PATID),
        'No Doctor'
    ) AS "Dr_Name"
FROM LTHMS.PATIENTS PNTS
LEFT JOIN (
    SELECT DISTINCT SID, PATID
    FROM LTHMS.RECEIPTDETAIL
    WHERE RCPTDATE BETWEEN DATE '2025-01-01' AND DATE '2025-01-31'
) RD  
    ON PNTS.PATID = RD.PATID
WHERE PNTS.REGISDATE BETWEEN DATE '2025-01-01' AND DATE '2025-01-31'
GROUP BY PNTS.PATID;
