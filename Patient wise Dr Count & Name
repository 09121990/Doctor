WITH DeduplicatedDoctors AS (
    SELECT DISTINCT RD.PATID, CP.SNAME
    FROM LTHMS.RECEIPTDETAIL RD
    JOIN LTHMS.CLINICPERSONNEL CP ON RD.SID = CP.SID
    WHERE RD.RCPTDATE BETWEEN DATE '2025-01-01' AND DATE '2025-01-31'
)
SELECT 
    PNTS.PATID AS "Patient ID",
    COUNT(DISTINCT RD.SID) AS "Dr_ID",
    NVL(
        (SELECT LISTAGG(DD.SNAME, ', ') WITHIN GROUP (ORDER BY DD.SNAME)
         FROM DeduplicatedDoctors DD
         WHERE DD.PATID = PNTS.PATID),
        'No Doctor'
    ) AS "Dr_Name"
FROM LTHMS.PATIENTS PNTS
LEFT JOIN (
    SELECT DISTINCT SID, PATID
    FROM LTHMS.RECEIPTDETAIL
    WHERE RCPTDATE BETWEEN DATE '2025-01-01' AND DATE '2025-01-31'
) RD  
    ON PNTS.PATID = RD.PATID
WHERE PNTS.REGISDATE BETWEEN DATE '2025-01-01' AND DATE '2025-01-31'
GROUP BY PNTS.PATID;
-----------------PROCEDURE COUNT
SELECT PATID, COUNT(SID) AS Dr_ID
FROM OPTCHARGEDETAIL 
WHERE BILLDATE BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                  AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
                        GROUP BY PATID;
--------------------ONLY UNIQUE DR COUNT PATIEN WISE & FILTE 
SELECT PATID, COUNT(DISTINCT SID) AS Dr_ID
FROM RECEIPTDETAIL 
WHERE RCPTDATE BETWEEN TO_DATE('2025-01-01', 'YYYY-MM-DD') 
                    AND TO_DATE('2025-01-31', 'YYYY-MM-DD')
  AND AMOUNT > 0
GROUP BY PATID
HAVING COUNT(DISTINCT SID) > 1;  -- Use HAVING instead of WHERE
